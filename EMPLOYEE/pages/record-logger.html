<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log Transaction</title>
  <link rel="stylesheet" href="../css/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-top">
        <i class="fas fa-arrow-left" onclick="navigate('index')"></i>
        <h1>Log Transaction</h1>
      </div>
    </header>

    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab('momo')">MoMo</button>
      <button class="tab-btn" onclick="switchTab('bank')">Bank</button>
    </div>

    <!-- MoMo Form -->
    <form id="momoForm" class="tab-content active">
      <div class="form-group">
        <label>Customer Phone</label>
        <input type="tel" id="customerPhone" placeholder="e.g., 0241234567" required>
      </div>
      <div class="form-group">
        <label>Amount (GHS)</label>
        <input type="number" id="amount" min="0.01" step="0.01" placeholder="0.00" required>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="type" required>
          <option value="">Select</option>
          <option value="deposit">Deposit (Receive)</option>
          <option value="withdraw">Withdrawal (Send)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Network</label>
        <select id="network" required>
          <option value="">Select</option>
          <option value="MTN">MTN</option>
          <option value="Vodafone">Vodafone</option>
          <option value="AirtelTigo">AirtelTigo</option>
        </select>
      </div>
      <div class="form-group">
        <label>Reference (optional)</label>
        <input type="text" id="reference" placeholder="e.g., Goods, Fees">
      </div>
      <button type="submit">Log MoMo Transaction</button>
    </form>

    <!-- Bank Form -->
    <form id="bankForm" class="tab-content">
      <div class="form-group">
        <label>Customer Name</label>
        <input type="text" id="customerName" placeholder="Full Name" required>
      </div>
      <div class="form-group">
        <label>Account Number</label>
        <input type="text" id="accountNumber" placeholder="e.g., 1234567890" required>
      </div>
      <div class="form-group">
        <label>Amount (GHS)</label>
        <input type="number" id="bankAmount" min="0.01" step="0.01" placeholder="0.00" required>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="bankType" required>
          <option value="">Select</option>
          <option value="deposit">Deposit (Receive)</option>
          <option value="withdraw">Withdrawal (Send)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Bank</label>
        <select id="bankName" required>
          <option value="">Select</option>
          <option value="GTBank">GTBank</option>
          <option value="Ecobank">Ecobank</option>
          <option value="Stanbic">Stanbic</option>
          <option value="Zenith">Zenith</option>
        </select>
      </div>
      <div class="form-group">
        <label>Reference (optional)</label>
        <input type="text" id="bankReference" placeholder="e.g., Salary, Goods">
      </div>
      <button type="submit">Log Bank Transaction</button>
    </form>

    <div id="result" class="result"></div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tab + 'Form').classList.add('active');
      event.target.classList.add('active');
    }

    function navigate(page) {
      window.location.href = page + '.html';
    }

    // MoMo Submit
    document.getElementById('momoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        customer_phone: document.getElementById('customerPhone').value,
        amount: document.getElementById('amount').value,
        type: document.getElementById('type').value,
        network: document.getElementById('network').value,
        reference: document.getElementById('reference').value,
        agent_name: user.first_name || 'Agent'
      };

      const res = await fetch('/api/records/log-momo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...getHeaders() },
        body: JSON.stringify(formData)
      });
      const data = await res.json();

      const result = document.getElementById('result');
      if (data.status) {
        result.innerHTML = `<p style="color: green;">Logged! ID: ${data.transactionId}</p>`;
        e.target.reset();
        // Real-time emit
        socket.emit('newRecord', { txnId: data.transactionId, type: formData.type, amount: formData.amount });
      } else {
        result.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
      }
    });

    // Bank Submit (similar)
    document.getElementById('bankForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        customer_name: document.getElementById('customerName').value,
        account_number: document.getElementById('accountNumber').value,
        amount: document.getElementById('bankAmount').value,
        type: document.getElementById('bankType').value,
        bank_name: document.getElementById('bankName').value,
        reference: document.getElementById('bankReference').value,
        agent_name: user.first_name || 'Agent'
      };

      const res = await fetch('/api/records/log-bank', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...getHeaders() },
        body: JSON.stringify(formData)
      });
      const data = await res.json();

      const result = document.getElementById('result');
      if (data.status) {
        result.innerHTML = `<p style="color: green;">Logged! ID: ${data.transactionId}</p>`;
        e.target.reset();
        socket.emit('newRecord', { txnId: data.transactionId, type: formData.type, amount: formData.amount });
      } else {
        result.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
      }
    });

    // Socket.IO
    const socket = io('http://localhost:8000');
    socket.on('connect', () => socket.emit('joinAgent', user.id));

    function getHeaders() {
      const token = localStorage.getItem('token');
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }
  </script>
</body>
</html>