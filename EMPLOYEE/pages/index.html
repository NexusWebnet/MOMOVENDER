<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Employee Dashboard â€” Record Keeper</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* Your exact CSS remains unchanged */
    * { box-sizing:border-box; }
    
    body {
      margin:0;
      font-family:"Poppins",sans-serif;
      min-height:100vh;
      background: url('../../ASSETS/images/logo.jpeg') center/cover no-repeat fixed;
      position:relative;
    }
    body::before {
      content:'';
      position:absolute;
      top:0; left:0; right:0; bottom:0;
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(10px);
      z-index:-1;
    }

    .sidebar {
      position:fixed;
      left:0;
      top:0;
      width:280px;
      height:100%;
      background: linear-gradient(180deg, #a777e8 0%, #7a5fc0 50%, #524598 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.15);
      color:white;
      z-index:1000;
      overflow-y:auto;
      box-shadow: 10px 0 30px rgba(0,0,0,0.2);
      transition: transform 0.4s ease;
      display:flex;
      flex-direction:column;
    }

    .sidebar-header {
      padding:40px 20px 30px;
      text-align:center;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .profile-section {
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .profile-pic {
      width:100px;
      height:100px;
      border-radius:50%;
      background:#ffb300;
      margin:0 auto 15px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      color:#4a148c;
      font-weight:bold;
      overflow:hidden;
      border:4px solid rgba(255,255,255,0.3);
      box-shadow:0 8px 25px rgba(0,0,0,0.3);
    }

    .profile-pic img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .profile-name {
      font-size:22px;
      font-weight:700;
      margin:0 0 5px 0;
      letter-spacing:1px;
    }

    .profile-role {
      font-size:15px;
      opacity:0.9;
      font-weight:400;
    }

    .menu-list {
      list-style:none;
      padding:10px 0;
      margin:0;
      flex-grow:1;
    }

    .menu-item {
      padding:18px 30px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:18px;
      font-size:17px;
      font-weight:500;
      transition:all 0.3s ease;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.12);
      padding-left:38px;
    }

    .menu-item.active {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      margin: 8px 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }

    .menu-item i {
      font-size:22px;
      width:30px;
      text-align:center;
    }

    .logout-item {
      padding:18px 30px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:18px;
      font-size:17px;
      font-weight:500;
      background: rgba(255, 255, 255, 0.1);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      transition:all 0.3s ease;
    }

    .logout-item:hover {
      background: rgba(220, 50, 50, 0.4);
      padding-left:38px;
    }

    .logout-item i {
      font-size:22px;
      width:30px;
      text-align:center;
    }

    .main-content {
      margin-left:280px;
      margin-right:300px;
      min-height:100vh;
      transition:margin-left 0.3s ease;
      padding:20px;
    }

    .header {
      background: rgba(106, 27, 154, 0.9);
      backdrop-filter: blur(12px);
      color:white;
      padding:15px 60px 15px 20px;
      font-size:20px;
      position:relative;
      border-radius:15px;
      margin-bottom:20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align:center;
    }
    .header .hamburger {
      position:absolute;
      left:20px;
      top:50%;
      transform:translateY(-50%);
      font-size:24px;
      cursor:pointer;
      display:none;
    }
    #welcomeText {
      margin:0;
      font-size:20px;
      font-weight:600;
    }

    .search-bar {
      margin:0 0 20px 0;
      padding:14px 16px;
      border-radius:15px;
      border:1px solid rgba(0,0,0,0.1);
      font-size:16px;
      background:rgba(255,255,255,0.8);
      backdrop-filter:blur(12px);
      display:flex;
      align-items:center;
      gap:12px;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
    }
    .search-bar i { color:#999; }

    .cards-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      margin-bottom:20px;
    }
    .card {
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(12px);
      border-radius:20px;
      box-shadow:0 8px 25px rgba(0,0,0,0.1);
      overflow:hidden;
      transition:transform 0.3s;
    }
    .card:hover { transform:translateY(-8px); }
    .card-content {
      padding:25px;
      text-align:center;
    }
    .card-icon {
      font-size:45px;
      color:#6a1b9a;
      margin-bottom:15px;
    }

    .stat-card.commission {
      grid-column:1 / -1;
      background:rgba(106,27,154,0.9);
      backdrop-filter:blur(12px);
      color:white;
      text-align:center;
      padding:30px;
      border-radius:20px;
      box-shadow:0 8px 25px rgba(0,0,0,0.15);
    }
    .stat-card.commission h3 { margin:0 0 10px 0; font-size:22px; }

    .buttons-sections {
      margin:30px 0;
    }
    .button-row {
      display:flex;
      gap:15px;
      margin-bottom:15px;
      flex-wrap:wrap;
    }
    .button-card {
      flex:1;
      min-width:200px;
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(12px);
      padding:25px;
      border-radius:20px;
      box-shadow:0 8px 25px rgba(0,0,0,0.1);
      text-align:center;
      cursor:pointer;
      transition:all 0.3s;
    }
    .button-card:hover { 
      transform:translateY(-8px);
      box-shadow:0 12px 30px rgba(0,0,0,0.2);
    }
    .button-card i { 
      font-size:35px; 
      color:#6a1b9a; 
      margin-bottom:12px; 
    }

    .transaction-table {
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(12px);
      border-radius:20px;
      overflow:hidden;
      box-shadow:0 8px 25px rgba(0,0,0,0.1);
    }
    .table-header {
      background:rgba(106,27,154,0.9);
      color:white;
      display:grid;
      grid-template-columns:2fr 1fr 1.5fr 1fr;
      padding:18px;
      font-weight:bold;
    }
    .table-body {
      max-height:450px;
      overflow-y:auto;
    }
    .table-row {
      display:grid;
      grid-template-columns:2fr 1fr 1.5fr 1fr;
      padding:18px;
      border-bottom:1px solid rgba(0,0,0,0.05);
      transition:background 0.2s;
    }
    .table-row:hover {
      background:rgba(106,27,154,0.05);
    }
    .amount { color:#2e7d32; font-weight:bold; }
    .no-data, .loading { text-align:center; padding:60px; color:#777; font-size:18px; }

    .right-panel {
      position:fixed;
      right:0;
      top:0;
      width:300px;
      height:100%;
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(12px);
      box-shadow:-10px 0 30px rgba(0,0,0,0.15);
      padding:30px 20px;
      overflow-y:auto;
    }
    .right-panel h3 {
      color:#6a1b9a;
      border-bottom:2px solid #6a1b9a;
      padding-bottom:12px;
      margin-bottom:20px;
    }

    @media (max-width:1200px) {
      .main-content { margin-right:0; }
      .right-panel { display:none; }
    }

    @media (max-width:992px) {
      .sidebar { transform:translateX(-100%); }
      .sidebar.open { transform:translateX(0); }
      .main-content { margin-left:0; padding:15px; }
      .main-content.sidebar-open { margin-left:280px; }
      .header { padding:15px 60px 15px 60px; }
      .header .hamburger { display:block; }
    }

    @media (max-width:576px) {
      .main-content.sidebar-open { margin-left:0; }
      .header { padding:15px 55px 15px 55px; }
      .cards-grid { grid-template-columns:1fr; }
      .button-row { flex-direction:column; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR WITH LOGO & LOGOUT -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="profile-section">
        <div class="profile-pic" id="profilePic">
          <span id="initials"></span>
          <img id="profileImage" src="" alt="Profile" style="display:none;">
        </div>
        <div class="profile-name" id="sidebarName">Loading...</div>
        <div class="profile-role">Employee</div>
      </div>
    </div>

    <ul class="menu-list">
      <li class="menu-item active"><i class="fas fa-home"></i> Dashboard</li>
      <li class="menu-item" onclick="navigate('momo-transactions')"><i class="fas fa-mobile-alt"></i> MoMo Transactions</li>
      <li class="menu-item" onclick="navigate('bank-deposits')"><i class="fas fa-university"></i> Bank Deposits</li>
      <li class="menu-item" onclick="navigate('bank-withdrawal-history')"><i class="fas fa-money-bill-wave"></i> Bank Withdrawals</li>
      <li class="menu-item" onclick="navigate('sim-registration-history')"><i class="fas fa-user-plus"></i> SIM Registration</li>
      <li class="menu-item" onclick="navigate('susu-history')"><i class="fas fa-piggy-bank"></i> Susu</li>
      <li class="menu-item" onclick="navigate('airtime-history')"><i class="fas fa-phone-volume"></i> Airtime</li>
      <li class="menu-item" onclick="navigate('my-history')"><i class="fas fa-history"></i> My History</li>
      <li class="menu-item" onclick="navigate('profile')"><i class="fas fa-user"></i> Profile</li>
    </ul>

    <div class="logout-item" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">
    <div class="header">
      <i class="fas fa-bars hamburger" id="hamburger"></i>
      <h1 id="welcomeText">Welcome!</h1>
      <i class="fas fa-bell header-icon right" onclick="navigate('notifications')">
        <span id="notificationBadge" class="badge">0</span>
      </i>
    </div>

    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Search transactions..." id="searchInput">
    </div>

    <!-- 4 CARDS GRID -->
    <div class="cards-grid">
      <div class="card">
        <div class="card-content">
          <i class="fas fa-exchange-alt card-icon"></i>
          <h2>Total Logged Today</h2>
          <p class="amount" id="totalToday">GHC 0.00</p>
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <i class="fas fa-mobile-alt card-icon"></i>
          <h2>MoMo Logs</h2>
          <p class="amount" id="momoToday">0</p>
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <i class="fas fa-university card-icon"></i>
          <h2>Bank Logs</h2>
          <p class="amount" id="bankToday">0</p>
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <i class="fas fa-file-alt card-icon"></i>
          <h2>Total Records</h2>
          <p class="amount" id="totalRecords">0</p>
        </div>
      </div>

      <div class="stat-card commission">
        <h3>Commission Today</h3>
        <p id="commissionToday">GHC 0.00</p>
      </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="buttons-sections">
      <div class="button-row">
        <div class="button-card" onclick="navigate('momo_transaction')"><i class="fas fa-mobile-alt"></i><span>Momo Transactions</span></div>
        <div class="button-card" onclick="navigate('bank_deposit')"><i class="fas fa-university"></i><span>Bank Deposit</span></div>
        <div class="button-card" onclick="navigate('bank_withdrawal')"><i class="fas fa-money-bill-wave"></i><span>Bank Withdrawal</span></div>
      </div>
      <div class="button-row">
        <div class="button-card" onclick="navigate('registration-logger')"><i class="fas fa-user-plus"></i><span>Sim Registration</span></div>
        <div class="button-card" onclick="navigate('susu-logger')"><i class="fas fa-piggy-bank"></i><span>Susu</span></div>
        <div class="button-card" onclick="navigate('airtime-logger')"><i class="fas fa-phone-volume"></i><span>Airtime</span></div>
      </div>
    </div>

    <h3 style="padding:0 0 10px 0;">Transaction History</h3>
    <h4 style="padding:0 0 20px 0; color:#666;">All Recent Transactions</h4>

    <div class="transaction-table">
      <div class="table-header">
        <span>Customer & Type</span>
        <span>Amount</span>
        <span>Date & Time</span>
        <span>Source</span>
      </div>
      <div class="table-body" id="transactionBody">
        <div class="loading">Loading transactions...</div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL - NOTIFICATIONS -->
  <aside class="right-panel">
    <h3>Recent Notifications</h3>
    <div id="notificationsList">Loading...</div>
  </aside>

 <script>
  const token = localStorage.getItem('token');
  const user = JSON.parse(localStorage.getItem('user') || '{}');

  function navigate(page) {
    const pages = {
      'momo-transactions': 'momo-transactions.html',
      'bank-deposits': 'bank-deposits.html',
      'bank-withdrawal-history': 'bank-withdrawal-history.html',
      'sim-registration-history': 'sim-registration-history.html',
      'susu-history': 'susu-history.html',
      'airtime-history': 'airtime-history.html',
      'my-history': 'my-history.html',
      'profile': 'profile.html',
      'notifications': 'notifications.html',

      'momo_transaction': 'momo_transaction.html',
      'bank_deposit': 'bank_deposit.html',
      'bank_withdrawal': 'bank_withdrawal.html',
      'registration-logger': 'registration-logger.html',
      'susu-logger': 'susu-logger.html',
      'airtime-logger': 'airtime-logger.html'
    };

    if (pages[page]) {
      window.location.href = pages[page];
    } else {
      alert('Page not found');
    }
  }

  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }
  }

  const hamburger = document.getElementById('hamburger');
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');

  hamburger.addEventListener('click', (e) => {
    e.stopPropagation();
    sidebar.classList.toggle('open');
    mainContent.classList.toggle('sidebar-open');
  });

  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 992 && 
        sidebar.classList.contains('open') && 
        !sidebar.contains(e.target) && 
        !hamburger.contains(e.target)) {
      sidebar.classList.remove('open');
      mainContent.classList.remove('sidebar-open');
    }
  });

  function loadProfileInSidebar() {
    const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'Employee';
    document.getElementById('sidebarName').textContent = fullName;
    document.getElementById('welcomeText').textContent = `Welcome, ${fullName}!`;

    const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2);
    document.getElementById('initials').textContent = initials;

    const savedPic = localStorage.getItem('profilePic');
    if (savedPic) {
      document.getElementById('profileImage').src = savedPic;
      document.getElementById('profileImage').style.display = 'block';
      document.getElementById('initials').style.display = 'none';
    }
  }

  async function loadDashboard() {
    if (!token) {
      alert('Please login first');
      window.location.href = '/login.html';
      return;
    }

    try {
      const today = new Date().toISOString().slice(0, 10);

      const responses = await Promise.all([
        fetch(`/api/transactions/momo?start=${today}&end=${today}`, { headers: { Authorization: `Bearer ${token}` } }).catch(() => ({ ok: false, json: async () => ({ data: [] }) })),
        fetch(`/api/transactions/bank?start=${today}&end=${today}`, { headers: { Authorization: `Bearer ${token}` } }).catch(() => ({ ok: false, json: async () => ({ data: [] }) })),
        fetch(`/api/transactions/airtime?start=${today}&end=${today}`, { headers: { Authorization: `Bearer ${token}` } }).catch(() => ({ ok: false, json: async () => ({ data: [] }) })),
        fetch(`/api/transactions/sim?start=${today}&end=${today}`, { headers: { Authorization: `Bearer ${token}` } }).catch(() => ({ ok: false, json: async () => ({ data: [] }) }))
      ]);

      const [momoRes, bankRes, airtimeRes, simRes] = await Promise.all(responses.map(r => r.json()));

      // Calculate sums for money (total amount) and counts for records
      const momoMoney = momoRes.data?.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0) || 0;
      const bankMoney = bankRes.data?.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0) || 0;
      const airtimeMoney = airtimeRes.data?.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0) || 0;
      const simMoney = simRes.data?.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0) || 0;

      const totalMoneyToday = momoMoney + bankMoney + airtimeMoney + simMoney;
      const totalRecordsToday = 
        (momoRes.data?.length || 0) + 
        (bankRes.data?.length || 0) + 
        (airtimeRes.data?.length || 0) + 
        (simRes.data?.length || 0);

      // Update cards
      document.getElementById('totalToday').textContent = `GHC ${totalMoneyToday.toFixed(2)}`;
      document.getElementById('momoToday').textContent = `GHC ${momoMoney.toFixed(2)}`;  // Now shows MoMo total money
      document.getElementById('bankToday').textContent = `GHC ${bankMoney.toFixed(2)}`;  // Now shows Bank total money
      document.getElementById('totalRecords').textContent = totalRecordsToday;
      document.getElementById('commissionToday').textContent = `GHC ${(totalMoneyToday * 0.015).toFixed(2)}`;

      // Build today's transactions table
      const allTodayTxns = [
        ...(momoRes.data || []).map(t => ({ ...t, service: 'MoMo' })),
        ...(bankRes.data || []).map(t => ({ ...t, service: 'Bank' })),
        ...(airtimeRes.data || []).map(t => ({ ...t, service: 'Airtime' })),
        ...(simRes.data || []).map(t => ({ ...t, service: 'SIM' }))
      ];

      const tbody = document.getElementById('transactionBody');
      tbody.innerHTML = '';

      if (allTodayTxns.length === 0) {
        tbody.innerHTML = '<div class="no-data">No transactions today</div>';
      } else {
        allTodayTxns.forEach(t => {
          const row = document.createElement('div');
          row.className = 'table-row';
          row.innerHTML = `
            <span>${t.customer_name || 'Unknown'}<br><small>${t.type || t.service || 'Transaction'}</small></span>
            <span class="amount">GHC ${parseFloat(t.amount || 0).toFixed(2)}</span>
            <span>${new Date(t.created_at).toLocaleString()}</span>
            <span>${t.network || t.bank_name || t.service || 'N/A'}</span>
          `;
          tbody.appendChild(row);
        });
      }

    } catch (err) {
      console.error('Dashboard load error:', err);
      document.getElementById('transactionBody').innerHTML = '<div class="error">Error loading data. Try refreshing.</div>';
    }
  }

  loadProfileInSidebar();
  loadDashboard();

  setInterval(loadDashboard, 30000);
</script>
</body>
</html>