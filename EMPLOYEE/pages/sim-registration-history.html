<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>SIM Registration History</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { box-sizing:border-box; }
    
    /* FULL PAGE BACKGROUND WITH LOGO */
    body {
      margin:0;
      font-family:"Poppins",sans-serif;
      min-height:100vh;
      background: url('../../ASSETS/images/logo.jpeg') center/cover no-repeat fixed;
      position:relative;
    }
    body::before {
      content:'';
      position:absolute;
      top:0; left:0; right:0; bottom:0;
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(10px);
      z-index:-1;
    }

    /* GLASSMORPHISM SIDEBAR - PURPLE-BLUE GRADIENT */
    .sidebar {
      position:fixed;
      left:0;
      top:0;
      width:280px;
      height:100%;
      background: linear-gradient(180deg, #a777e8 0%, #7a5fc0 50%, #524598 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.15);
      color:white;
      z-index:1000;
      overflow-y:auto;
      box-shadow: 10px 0 30px rgba(0,0,0,0.2);
      transition: transform 0.4s ease;
      display:flex;
      flex-direction:column;
    }

    .sidebar-header {
      padding:40px 20px 30px;
      text-align:center;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .profile-section {
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .profile-pic {
      width:100px;
      height:100px;
      border-radius:50%;
      object-fit:cover;
      border: 4px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .user-name {
      margin:15px 0 5px 0;
      font-size:22px;
      font-weight:700;
      letter-spacing:1px;
    }

    .user-role {
      margin:0;
      font-size:15px;
      opacity:0.9;
      font-weight:400;
    }

    .menu-list {
      list-style:none;
      padding:10px 0;
      margin:0;
      flex-grow:1;
    }

    .menu-item {
      padding:18px 30px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:18px;
      font-size:17px;
      font-weight:500;
      transition:all 0.3s ease;
    }

    .menu-item:hover {
      background: rgba(255, 255, 255, 0.12);
      padding-left:38px;
    }

    .menu-item.active {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      margin: 8px 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }

    .menu-item i {
      font-size:22px;
      width:30px;
      text-align:center;
    }

    /* LOGOUT BUTTON */
    .logout-item {
      padding:18px 30px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:18px;
      font-size:17px;
      font-weight:500;
      background: rgba(255, 255, 255, 0.1);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      transition:all 0.3s ease;
    }

    .logout-item:hover {
      background: rgba(220, 50, 50, 0.4);
      padding-left:38px;
    }

    .logout-item i {
      font-size:22px;
      width:30px;
      text-align:center;
    }

    /* MAIN CONTENT */
    .main-content {
      margin-left:280px;
      min-height:100vh;
      transition:margin-left 0.3s ease;
      padding:20px;
    }

    .header {
      background: rgba(0, 188, 212, 0.9);
      backdrop-filter: blur(12px);
      color:white;
      padding:15px 60px 15px 20px;
      font-size:20px;
      position:relative;
      border-radius:15px;
      margin-bottom:20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align:center;
    }
    .header .hamburger {
      position:absolute;
      left:20px;
      top:50%;
      transform:translateY(-50%);
      font-size:24px;
      cursor:pointer;
      display:none;
    }
    .header-title {
      margin:0;
      font-size:20px;
      font-weight:600;
    }

    .container { 
      max-width:1300px; 
      margin:auto; 
    }

    .search-bar, 
    .filter-card, 
    table, 
    .export-btn {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .search-bar { 
      width:100%; 
      padding:14px 16px; 
      border-radius:15px; 
      font-size:16px; 
      margin-bottom:20px;
    }
    
    .filter-card { 
      padding:25px; 
      border-radius:20px; 
      margin-bottom:20px; 
    }
    .date-row { 
      display:flex; 
      gap:15px; 
      flex-wrap:wrap; 
      margin-bottom:20px; 
    }
    .date-row input { 
      flex:1; 
      min-width:200px; 
      padding:12px; 
      border-radius:12px; 
      border:1px solid rgba(0,0,0,0.1);
    }
    .apply-btn { 
      background:#ffb300; 
      color:black; 
      border:none; 
      padding:14px 30px; 
      border-radius:50px; 
      font-weight:bold; 
      cursor:pointer; 
      width:100%; 
      font-size:16px; 
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(255,177,0,0.3);
    }
    .apply-btn:hover { 
      background:#ffa000; 
      transform:translateY(-2px);
    }
    
    .export-buttons { 
      display:flex; 
      gap:15px; 
      margin:25px 0; 
    }
    .export-btn { 
      flex:1; 
      padding:14px; 
      border-radius:15px; 
      font-weight:bold; 
      cursor:pointer; 
      transition:all 0.2s;
    }
    .export-btn:hover { 
      transform:translateY(-3px);
      opacity:0.95;
    }
    .pdf-btn { background:#e91e63; }
    .excel-btn { background:#1e88e5; }

    table { 
      border-radius:20px; 
      overflow:hidden; 
      width:100%; /* FULL WIDTH */
    }
    th { 
      background:rgba(0, 188, 212, 0.9); 
      padding:18px; 
    }
    td { 
      padding:18px; 
    }
    .amount { 
      font-weight:bold; 
      color:#00695c; 
    }
    .network { 
      padding:8px 14px; 
      border-radius:20px; 
      font-size:13px; 
      font-weight:bold; 
      color:white; 
    }
    .mtn { background:#f9a825; }
    .vodafone { background:#e20074; }
    .airteltigo { background:#d32f2f; }
    .glo { background:#4caf50; }
    .no-data { 
      padding:80px; 
      font-size:18px; 
    }

    /* MOBILE VIEW */
    @media (max-width:992px) {
      .sidebar {
        transform:translateX(-100%);
      }
      .sidebar.open { transform:translateX(0); }
      .main-content { 
        margin-left:0; 
        padding:15px;
      }
      .main-content.sidebar-open { margin-left:280px; }
      .header { 
        padding:15px 60px 15px 60px;
      }
      .header .hamburger { display:block; }
    }

    @media (max-width:576px) {
      .main-content.sidebar-open { margin-left:0; }
      .header { padding:15px 55px 15px 55px; }
      .date-row { flex-direction:column; }
      .export-buttons { flex-direction:column; }
      table { font-size:14px; }
      th, td { padding:12px; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR WITH LOGO & LOGOUT -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="profile-section">
        <img src="../../ASSETS/images/logo.jpeg" alt="MIB Logo" class="profile-pic">
        <h3 class="user-name">MIB</h3>
        <p class="user-role">MoMo Vendor</p>
      </div>
    </div>

    <ul class="menu-list">
      <li class="menu-item" onclick="navigate('index')"><i class="fas fa-home"></i> Dashboard</li>
      <li class="menu-item" onclick="navigate('momo-transactions')"><i class="fas fa-mobile-alt"></i> MoMo Transactions</li>
      <li class="menu-item" onclick="navigate('bank-deposits')"><i class="fas fa-university"></i> Bank Deposits</li>
      <li class="menu-item" onclick="navigate('bank-withdrawal-history')"><i class="fas fa-money-bill-wave"></i> Bank Withdrawals</li>
      <li class="menu-item active"><i class="fas fa-user-plus"></i> SIM Registration</li>
      <li class="menu-item" onclick="navigate('susu-history')"><i class="fas fa-piggy-bank"></i> Susu</li>
      <li class="menu-item" onclick="navigate('airtime-history')"><i class="fas fa-phone-volume"></i> Airtime</li>
      <li class="menu-item" onclick="navigate('my-history')"><i class="fas fa-history"></i> My History</li>
      <li class="menu-item" onclick="navigate('profile')"><i class="fas fa-user"></i> Profile</li>
    </ul>

    <div class="logout-item" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">
    <div class="header">
      <i class="fas fa-bars hamburger" id="hamburger"></i>
      <h1 class="header-title">SIM Registration History</h1>
    </div>

    <div class="container">
      <input type="text" class="search-bar" id="searchInput" placeholder="Search by name, phone or ID..." />

      <div class="filter-card">
        <h3 style="margin-top:0; color:#00bcd4;">Filter SIM Registrations</h3>
        <div class="date-row">
          <input type="date" id="startDate" />
          <input type="date" id="endDate" />
        </div>
        <button class="apply-btn" onclick="applyFilter()">Apply Filters</button>
      </div>

      <div class="export-buttons">
        <button class="export-btn pdf-btn" onclick="exportToPDF()">Download PDF</button>
        <button class="export-btn excel-btn" onclick="exportToExcel()">Download Excel</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Customer</th>
            <th>Phone Number</th>
            <th>Network</th>
            <th>ID Type</th>
            <th>ID Number</th>
            <th>Amount</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="transactionsBody">
          <tr><td colspan="7" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Inline JavaScript (no external api.js needed) -->
  <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    window.navigate = (page) => location.href = page + '.html';

    let allRegistrations = [];

    // Sidebar toggle
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');

    hamburger.addEventListener('click', (e) => {
      e.stopPropagation();
      sidebar.classList.toggle('open');
      mainContent.classList.toggle('sidebar-open');
    });

    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 992 && 
          sidebar.classList.contains('open') && 
          !sidebar.contains(e.target) && 
          !hamburger.contains(e.target)) {
        sidebar.classList.remove('open');
        mainContent.classList.remove('sidebar-open');
      }
    });

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      }
    }

    async function loadRegistrations() {
      if (!token) {
        alert("Please login first");
        window.location.href = '/login.html';
        return;
      }

      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 30);

      document.getElementById('startDate').value = start.toISOString().split('T')[0];
      document.getElementById('endDate').value = end.toISOString().split('T')[0];

      await fetchRegistrations(start, end);
    }

    async function fetchRegistrations(startDate, endDate) {
      try {
        const startStr = startDate.toISOString().split('T')[0];
        const endStr = endDate.toISOString().split('T')[0];

        const res = await fetch(`/api/transactions/sim?start=${startStr}&end=${endStr}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          console.error(`HTTP ${res.status}: ${res.statusText}`);
          throw new Error(`Failed to load SIM registrations (HTTP ${res.status})`);
        }

        const response = await res.json();

        let simData = [];
        if (response.success && Array.isArray(response.data)) {
          simData = response.data;
        } else if (Array.isArray(response)) {
          simData = response;
        }

        allRegistrations = simData;
        renderTable(allRegistrations);
      } catch (err) {
        console.error('SIM registration load error:', err);
        document.getElementById('transactionsBody').innerHTML = 
          `<tr><td colspan="7" class="no-data">Error loading SIM registrations: ${err.message}</td></tr>`;
      }
    }

    function renderTable(registrations) {
      const tbody = document.getElementById('transactionsBody');
      if (registrations.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data">No SIM registrations found</td></tr>`;
        return;
      }

      tbody.innerHTML = registrations.map(r => {
        const networkClass = (r.network || '').toLowerCase();
        return `
          <tr>
            <td>${r.customer_name || 'Unknown'}</td>
            <td>${r.customer_phone || '—'}</td>
            <td><span class="network ${networkClass}">${r.network || '—'}</span></td>
            <td>${r.id_type || '—'}</td>
            <td>${r.id_number || '—'}</td>
            <td class="amount">GHS ${parseFloat(r.amount || 5).toFixed(2)}</td>
            <td>${new Date(r.created_at).toLocaleDateString()}</td>
          </tr>
        `;
      }).join('');
    }

    window.applyFilter = async () => {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      if (!start || !end) return alert("Please select both dates");
      await fetchRegistrations(new Date(start), new Date(end));
    };

    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allRegistrations.filter(r => 
        (r.customer_name && r.customer_name.toLowerCase().includes(term)) ||
        (r.customer_phone && r.customer_phone.includes(term)) ||
        (r.id_number && r.id_number.includes(term))
      );
      renderTable(filtered);
    });

    window.exportToPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text("SIM Registration Report", 14, 20);
      doc.setFontSize(12);
      doc.text(`Agent: ${user.first_name || ''} ${user.last_name || ''}`, 14, 30);
      doc.text(`Period: ${document.getElementById('startDate').value} to ${document.getElementById('endDate').value}`, 14, 38);

      let y = 50;
      allRegistrations.forEach(r => {
        const line = `${new Date(r.created_at).toLocaleDateString()} | ${r.customer_name || 'Unknown'} | ${r.customer_phone || ''} | ${r.network || ''} | GHS ${r.amount || 5}`;
        doc.text(line, 14, y);
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save("sim_registrations.pdf");
    };

    window.exportToExcel = () => {
      const data = allRegistrations.map(r => ({
        Date: new Date(r.created_at).toLocaleDateString(),
        Customer: r.customer_name || 'Unknown',
        "Phone Number": r.customer_phone || '',
        Network: r.network || '',
        "ID Type": r.id_type || '',
        "ID Number": r.id_number || '',
        Amount: parseFloat(r.amount || 5),
        Reference: r.reference_note || ''
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "SIM Registrations");
      XLSX.writeFile(wb, "sim_registrations.xlsx");
    };

    window.addEventListener('DOMContentLoaded', loadRegistrations);
  </script>
</body>
</html>