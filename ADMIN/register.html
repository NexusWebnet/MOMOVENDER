<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Register â€” MIB MoMo Vendor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:"Poppins",sans-serif;
      min-height:100vh;
      background: url('../ASSETS/images/logo.jpeg') center/cover no-repeat fixed;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#333;
    }
    body::before {
      content:'';
      position:absolute;
      top:0; left:0; right:0; bottom:0;
      background: rgba(80, 40, 140, 0.75);
      backdrop-filter: blur(8px);
      z-index:-1;
    }
    .login-container {
      width:90%;
      max-width:420px;
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 30px;
      padding: 50px 40px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      text-align:center;
      border: 1px solid rgba(255,255,255,0.4);
    }
    .logo {
      width:120px;
      height:120px;
      border-radius:50%;
      object-fit:cover;
      border: 6px solid rgba(255,255,255,0.9);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom:25px;
    }
    .header h1 {
      font-size:28px;
      font-weight:800;
      color:#4a148c;
      margin-bottom:10px;
      letter-spacing:1px;
    }
    .header p {
      font-size:16px;
      color:#666;
      margin-bottom:30px;
    }
    .login-form {
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .input-group {
      position:relative;
    }
    .input-group i {
      position:absolute;
      left:20px;
      top:50%;
      transform:translateY(-50%);
      color:#8e24aa;
      font-size:20px;
      z-index:2;
    }
    .input-group input,
    .input-group select {
      width:100%;
      padding:18px 20px 18px 60px;
      border:2px solid rgba(106,27,154,0.3);
      border-radius:50px;
      font-size:17px;
      background:rgba(255,255,255,0.9);
      transition:all 0.3s ease;
      box-shadow:0 4px 15px rgba(0,0,0,0.05);
    }
    .input-group input:focus,
    .input-group select:focus {
      outline:none;
      border-color:#ffb300;
      background:white;
      box-shadow:0 0 0 4px rgba(255,177,0,0.2);
      transform:scale(1.02);
    }
    .login-btn {
      margin-top:20px;
      padding:18px;
      background: linear-gradient(135deg, #ffb300, #ff8c00);
      border:none;
      border-radius:50px;
      color:#000;
      font-size:18px;
      font-weight:bold;
      cursor:pointer;
      transition:all 0.4s ease;
      box-shadow:0 8px 25px rgba(255,177,0,0.4);
    }
    .login-btn:hover {
      transform:translateY(-5px);
      box-shadow:0 15px 35px rgba(255,177,0,0.5);
    }
    .login-btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }
    .extra-links {
      margin-top:25px;
      font-size:15px;
    }
    .extra-links a {
      color:#ffb300;
      text-decoration:none;
      font-weight:600;
    }
    .extra-links a:hover {
      color:#ff8c00;
      text-decoration:underline;
    }
    #toast {
      display: none;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }
    #toast.show {
      display: block;
      animation: slideIn 0.5s, slideOut 0.5s 3.5s forwards;
    }
    @keyframes slideIn { from { transform: translateX(-50%) translateY(100%); } to { transform: translateX(-50%) translateY(0); } }
    @keyframes slideOut { to { transform: translateX(-50%) translateY(100%); opacity: 0; } }
    @media (max-width:480px) {
      .login-container { padding:40px 30px; margin:20px; }
      h1 { font-size:24px; }
    }
  </style>
</head>
<body>

  <div class="login-container">
    <div class="login-box">
      <header class="header">
        <img src="../ASSETS/images/logo.jpeg" alt="Logo" class="logo">
        <h1>Create Account</h1>
        <p>Register a new user for MoMo Vendor</p>
      </header>

      <form id="register-form" class="login-form">
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="firstname" placeholder="First Name" required>
        </div>

        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="lastname" placeholder="Last Name" required>
        </div>

        <div class="input-group">
          <i class="fas fa-envelope"></i>
          <input type="email" id="email" placeholder="Email" required>
        </div>

        <div class="input-group">
          <i class="fas fa-phone"></i>
          <input type="tel" id="phone" placeholder="Phone Number (e.g., 0241234567)" required>
        </div>

        <div class="input-group">
          <i class="fas fa-user-shield"></i>
          <select id="role" required>
            <option value="" disabled selected>Select Role</option>
            <option value="manager">Manager</option>
            <option value="employee">Employee</option>
          </select>
        </div>

        <div class="input-group">
          <i class="fas fa-building"></i>
          <select id="branch_id">
            <option value="">No Branch (Optional)</option>
          </select>
        </div>

        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" placeholder="Password" required>
        </div>

        <button type="submit" class="login-btn" id="register-btn">Create User</button>
      </form>

      <div class="extra-links">
        <p>Already have an account? <a href="login.html">Login here</a></p>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast">
    <div class="bg-white text-gray-800 px-8 py-5 rounded-2xl shadow-2xl flex items-center gap-4">
      <i id="toast-icon" class="fas fa-check-circle text-3xl text-green-500"></i>
      <span id="toast-message" class="font-bold text-xl"></span>
    </div>
  </div>

  <script>
    function showToast(message, success = true) {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const msg = document.getElementById('toast-message');
      msg.textContent = message;
      icon.className = success ? "fas fa-check-circle text-3xl text-green-500" : "fas fa-exclamation-circle text-3xl text-red-500";
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 4000);
    }

    // Load branches
    async function loadBranches() {
      const token = localStorage.getItem('token');
      if (!token) {
        showToast('Please login first', false);
        setTimeout(() => window.location.href = 'login.html', 2000);
        return;
      }

      try {
        const res = await fetch('/api/branches', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success && data.branches) {
          const select = document.getElementById('branch_id');
          data.branches.forEach(b => {
            const option = document.createElement('option');
            option.value = b.id;
            option.textContent = b.name;
            select.appendChild(option);
          });
        }
      } catch (err) {
        console.error('Branch load error:', err);
        showToast('Failed to load branches', false);
      }
    }

    // Form submit
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('register-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      const first_name = document.getElementById('firstname').value.trim();
      const last_name = document.getElementById('lastname').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const role = document.getElementById('role').value;
      const branch_id = document.getElementById('branch_id').value || null;
      const password = document.getElementById('password').value;

      if (!first_name || !last_name || !email || !phone || !role || !password) {
        showToast('All required fields must be filled', false);
        btn.disabled = false;
        btn.textContent = 'Create User';
        return;
      }

      if (password.length < 6) {
        showToast('Password must be at least 6 characters', false);
        btn.disabled = false;
        btn.textContent = 'Create User';
        return;
      }

      const payload = {
        first_name,
        last_name,
        email,
        phone,
        role,
        password,
        branch_id
      };

      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok && data.success) {
          showToast(`User created successfully! Username: ${data.username || 'auto-generated'}`, true);
          setTimeout(() => {
            window.location.href = '/ADMIN/admin-agents.html'; // or wherever you want to go
          }, 2000);
        } else {
          const msg = data.message || 'Registration failed';
          showToast(msg, false);
          btn.disabled = false;
          btn.textContent = 'Create User';
        }
      } catch (err) {
        console.error('Register error:', err);
        showToast('Network error. Please try again.', false);
        btn.disabled = false;
        btn.textContent = 'Create User';
      }
    });

    // Load branches on start
    loadBranches();
  </script>
</body>
</html>