<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MoMo Empire - Owner Panel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', system-ui, sans-serif;
}

body {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

/* GLASS EFFECT */
.glass {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(14px);
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

/* LAYOUT */
.container {
  display: grid;
  grid-template-columns: 280px 1fr 350px;
  gap: 20px;
  padding: 20px;
  min-height: 100vh;
}

/* SIDEBAR */
.sidebar {
  padding: 30px 20px;
  position: sticky;
  top: 20px;
  height: fit-content;
}

.profile {
  text-align: center;
  margin-bottom: 40px;
}

.profile img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,0.35);
  object-fit: cover;
}

.profile h2 {
  margin-top: 15px;
  font-size: 22px;
}

.profile p {
  font-size: 14px;
  opacity: 0.85;
}

.menu {
  list-style: none;
}

.menu li {
  margin: 15px 0;
}

.menu a {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 18px;
  border-radius: 14px;
  color: #fff;
  text-decoration: none;
  transition: 0.3s;
}

.menu a:hover,
.menu a.active {
  background: rgba(255,255,255,0.25);
  transform: translateX(8px);
}

.menu i {
  font-size: 18px;
  width: 28px;
}

.logout-btn {
  margin-top: 30px;
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  background: rgba(220,38,38,0.35);
  border: none;
  color: #fff;
  cursor: pointer;
  font-size: 15px;
}

/* MAIN */
.main {
  padding: 10px;
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  padding: 25px;
  text-align: center;
}

.stat-card h3 {
  font-size: 17px;
  opacity: 0.9;
}

.stat-card .value {
  font-size: 44px;
  font-weight: bold;
  margin: 10px 0;
}

.stat-card .label {
  font-size: 14px;
  opacity: 0.8;
}

/* ACTIVITY */
.section {
  padding: 25px;
  margin-bottom: 25px;
}

.section h2 {
  font-size: 24px;
  margin-bottom: 20px;
}

.activity-feed {
  max-height: 500px;
  overflow-y: auto;
  padding-right: 6px;
}

.activity-item {
  display: flex;
  align-items: center;
  gap: 14px;
  background: rgba(255,255,255,0.12);
  padding: 14px;
  border-radius: 14px;
  margin-bottom: 12px;
}

.activity-item i {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  background: rgba(255,255,255,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* TOP AGENTS */
.agent-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.1);
  padding: 14px;
  border-radius: 14px;
  margin-bottom: 12px;
}

/* CHART */
canvas {
  margin-top: 30px;
  background: rgba(255,255,255,0.12);
  padding: 20px;
  border-radius: 20px;
}

/* NOTIFICATIONS */
.notifications {
  padding: 25px;
  position: sticky;
  top: 20px;
  height: fit-content;
}

.notif-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.notif-header h2 {
  font-size: 22px;
}

.notif-filters {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.notif-filters button {
  background: rgba(255,255,255,0.25);
  border: none;
  padding: 8px 14px;
  border-radius: 20px;
  color: #fff;
  cursor: pointer;
  font-size: 13px;
}

/* RESPONSIVE */
@media (max-width: 992px) {
  .container {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

  <div class="container">
    <!-- SIDEBAR -->
    <aside class="sidebar glass" id="sidebar">
      <div class="profile">
        <img id="admin-photo" src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin">
        <h2 id="admin-name">Loading...</h2>
        <p>Queen of the Empire</p>
      </div>
      <ul class="menu">
        <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="admin-agents.html"><i class="fas fa-users"></i> All Agents</a></li>
        <li><a href="admin-float.html"><i class="fas fa-wallet"></i> Float Control</a></li>
        <li><a href="admin-payroll.html"><i class="fas fa-money-bill-wave"></i> Pay Commission</a></li>
        <li><a href="admin-branch.html"><i class="fas fa-building"></i> Branches</a></li>
        <li><a href="admin-reports.html"><i class="fas fa-chart-bar"></i> Reports</a></li>
      </ul>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="stats">
        <div class="stat-card glass">
          <h3>Today's Total Sales</h3>
          <div class="value" id="today-sales">GHS 0</div>
          <div class="label">All Branches Combined</div>
        </div>
        <div class="stat-card glass">
          <h3>Total Shop Float</h3>
          <div class="value" id="total-float">GHS 0</div>
          <div class="label">All Agent Balances</div>
        </div>
        <div class="stat-card glass">
          <h3>Active Agents Today</h3>
          <div class="value" id="active-agents">0</div>
          <div class="label">Making Sales Right Now</div>
        </div>
      </div>

      <div class="glass p-6 mt-8">
        <h2 class="text-3xl font-bold mb-6">Live Activity Feed</h2>
        <div class="activity-feed" id="activity-feed">
          <p class="text-center py-10 opacity-70">Loading real-time transactions...</p>
        </div>
      </div>

      <div class="glass p-6 rounded-2xl mb-6">
        <h3 class="text-2xl font-bold mb-4">Top Agents</h3>
        <div id="agent-ranking" class="space-y-3">Loading...</div>
      </div>

      <canvas id="salesChart" height="120"></canvas>
    </main>

    <!-- NOTIFICATIONS -->
    <aside class="notifications glass">
      <div class="notif-header">
        <h2>Notifications</h2>
        <button onclick="toggleNotif()" class="text-2xl">×</button>
      </div>
      <div class="notif-filters">
        <button>All</button>
        <button>Float</button>
        <button>Sales</button>
        <button>Agents</button>
      </div>
      <div id="notif-list">
        <p class="text-center opacity-70">No notifications yet</p>
      </div>
    </aside>
  </div>

  <script>
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user') || '{}');

// SHOW USER INFO
document.getElementById('admin-name').textContent = user.first_name + " " + (user.last_name || "");
document.getElementById('admin-photo').src = user.photo || "https://randomuser.me/api/portraits/men/32.jpg";

// LOGOUT
function logout() { 
  localStorage.clear(); 
  window.location.href="../login.html"; 
}

// DASHBOARD
async function loadDashboard() {
  try {
    const res = await fetch('/api/admin/dashboard', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if(!res.ok) throw new Error("Failed to load dashboard");
    const data = await res.json();

    document.getElementById('today-sales').textContent = "GHS " + Number(data.today_sales || 0).toLocaleString();
    document.getElementById('total-float').textContent = "GHS " + Number(data.total_float || 0).toLocaleString();
    document.getElementById('active-agents').textContent = data.active_agents || 0;

    const feed = document.getElementById('activity-feed');
    feed.innerHTML = data.recent_activity.map(a => `
      <div class="activity-item">
        <i class="fas fa-exchange-alt"></i>
        <div>
          <strong>${a.name}</strong> ${a.action}
          <div style="opacity:0.8;font-size:14px;">${a.service} • ${a.time}</div>
        </div>
        <strong style="margin-left:auto;font-size:24px;">+GHS ${a.amount.toLocaleString()}</strong>
      </div>
    `).join('') || "<p class='text-center opacity-70'>No activity yet today</p>";
  } catch(err){
    console.error("Dashboard error:", err);
  }
}
loadDashboard();
setInterval(loadDashboard, 10000);

// AGENT RANKING
async function loadAgentRanking(period='day') {
  try {
    const res = await fetch(`/api/admin/agent-ranking?period=${period}&limit=6`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) throw new Error("Failed to load agent ranking");
    const { data } = await res.json();
    const container = document.getElementById('agent-ranking');
    container.innerHTML = '';

    data.forEach((a, i) => {
      const el = document.createElement('div');
      el.className = 'flex items-center justify-between p-3 bg-white/5 rounded-xl';
      el.innerHTML = `
        <div>
          <div class="text-lg font-bold">${i+1}. ${a.agent_name || 'Agent #' + a.agent_id}</div>
          <div class="text-sm text-purple-200">${a.total_tx} tx</div>
        </div>
        <div class="text-xl font-bold text-green-300">GHS ${Number(a.total_amount).toLocaleString()}</div>
      `;
      container.appendChild(el);
    });
  } catch(err) {
    console.error("Agent ranking error:", err);
  }
}
loadAgentRanking();

// SALES CHART
let salesChart;
async function drawSales(days=7) {
  try {
    const res = await fetch(`/api/admin/analytics/sales?days=${days}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) throw new Error("Failed to load sales analytics");
    const { data } = await res.json();

    const labels = data.map(r => r.day);
    const totals = data.map(r => Number(r.total || 0));
    const ctx = document.getElementById('salesChart').getContext('2d');

    if (salesChart) salesChart.destroy();
    salesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Sales',
          data: totals,
          fill: true,
          backgroundColor: 'rgba(255,255,255,0.2)',
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  } catch(err) {
    console.error("Sales chart error:", err);
  }
}
drawSales(7);
</script>

</body>
</html>
