<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Admin Dashboard — MIB MoMo Empire</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:"Poppins",sans-serif; min-height:100vh; background: url('../../ASSETS/images/logo.jpeg') center/cover no-repeat fixed; position:relative; color:#fff; }
    body::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background: rgba(80, 40, 140, 0.78); backdrop-filter: blur(10px); z-index:-1; }
    .container { display: grid; grid-template-columns: 280px 1fr 350px; gap: 25px; padding: 25px; min-height: 100vh; }
    .glass { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 15px 40px rgba(0,0,0,0.3); overflow: hidden; }
    .sidebar { padding: 30px 25px; position: sticky; top: 25px; height: fit-content; }
    .profile { text-align: center; margin-bottom: 40px; }
    .profile img { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 5px solid rgba(255,255,255,0.4); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .profile h2 { margin: 18px 0 8px; font-size: 24px; font-weight: 700; }
    .profile p { font-size: 16px; opacity: 0.9; }
    .menu { list-style: none; margin-top: 20px; }
    .menu li { margin: 12px 0; }
    .menu a { display: flex; align-items: center; gap: 16px; padding: 16px 20px; border-radius: 16px; color: #fff; text-decoration: none; font-size: 17px; font-weight: 500; transition: all 0.3s ease; }
    .menu a:hover, .menu a.active { background: rgba(255,255,255,0.25); transform: translateX(10px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .menu i { font-size: 20px; width: 30px; text-align: center; }
    .logout-btn { margin-top: 50px; width: 100%; padding: 16px; border-radius: 16px; background: rgba(220,38,38,0.4); border: none; color: #fff; cursor: pointer; font-size: 17px; font-weight: bold; transition: all 0.3s; }
    .logout-btn:hover { background: rgba(220,38,38,0.6); transform: translateY(-3px); }
    .main { display: flex; flex-direction: column; gap: 25px; }
    .period-toggle { display: flex; background: rgba(255,255,255,0.15); border-radius: 50px; padding: 6px; width: fit-content; margin-bottom: 10px; }
    .toggle-btn { padding: 10px 24px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .toggle-btn.active { background: #ffb300; color: #000; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
    .stat-card { padding: 30px; text-align: center; transition: transform 0.3s; }
    .stat-card:hover { transform: translateY(-10px); }
    .stat-card h3 { font-size: 18px; opacity: 0.9; margin-bottom: 10px; }
    .stat-card .value { font-size: 48px; font-weight: 900; margin: 15px 0; }
    .stat-card .label { font-size: 15px; opacity: 0.8; }
    .section { padding: 30px; }
    .section h2 { font-size: 26px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
    .activity-feed { max-height: 520px; overflow-y: auto; padding-right: 8px; display: flex; flex-direction: column; gap: 14px; }
    .activity-item { display: flex; align-items: center; gap: 16px; background: rgba(255,255,255,0.12); padding: 18px; border-radius: 18px; transition: all 0.3s; }
    .activity-item:hover { background: rgba(255,255,255,0.2); transform: translateX(8px); }
    .activity-item i { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,177,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .activity-amount { margin-left: auto; font-size: 24px; font-weight: bold; color: #ffb300; }
    .agent-ranking { display: flex; flex-direction: column; gap: 16px; }
    .agent-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 18px; border-radius: 18px; }
    .agent-rank { font-size: 20px; font-weight: bold; color: #ffb300; }
    .agent-name { font-size: 18px; font-weight: 600; }
    .agent-sales { font-size: 20px; font-weight: bold; color: #ffb300; }
    .chart-container { padding: 30px; background: rgba(255,255,255,0.12); border-radius: 24px; }
    canvas { max-height: 400px; }
    .notifications { padding: 30px; position: sticky; top: 25px; height: fit-content; }
    .notif-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .notif-header h2 { font-size: 24px; }
    .notif-close { font-size: 28px; cursor: pointer; opacity: 0.7; }
    .notif-filters { display: flex; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; }
    .notif-filters button { background: rgba(255,255,255,0.2); border: none; padding: 10px 18px; border-radius: 30px; color: #fff; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .notif-filters button.active { background: #ffb300; color: #000; }
    .header .hamburger { display: none; cursor: pointer; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 24px; color: white; }
    @media (max-width: 992px) { .header .hamburger { display: block !important; } .container { grid-template-columns: 1fr; } .sidebar { position: fixed; left: -300px; top: 0; height: 100%; z-index: 1000; transition: left 0.4s ease; } .sidebar.open { left: 0; } .main { margin-left: 0; } }

    /* Online Users Section */
    .online-user { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 8px; }
    .online-dot { width: 12px; height: 12px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(74,222,128,0.7); } 70% { box-shadow: 0 0 0 10px rgba(74,222,128,0); } 100% { box-shadow: 0 0 0 0 rgba(74,222,128,0); } }
  </style>
</head>
<body>
  <div class="container">
    <!-- SIDEBAR -->
    <aside class="sidebar glass" id="sidebar">
      <div class="profile">
        <img id="admin-photo" src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin">
        <h2 id="admin-name">Queen of Empire</h2>
        <p>System Administrator</p>
      </div>
      <ul class="menu" id="dynamic-menu">
        <li><p class="text-center opacity-70">Loading menu...</p></li>
      </ul>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">
      <div class="header">
        <i class="fas fa-bars hamburger" id="hamburger"></i>
        <h1 id="welcomeText">Welcome!</h1>
        <i class="fas fa-bell header-icon right">
          <span id="notificationBadge" class="badge">0</span>
        </i>
      </div>

      <!-- PERIOD TOGGLE WITH MONTH BUTTON -->
      <div class="period-toggle glass">
        <div class="toggle-btn active" onclick="switchPeriod('day')">Today</div>
        <div class="toggle-btn" onclick="switchPeriod('week')">This Week</div>
        <div class="toggle-btn" onclick="switchPeriod('month')">This Month</div>
      </div>

      <div class="stats">
        <div class="stat-card glass">
          <h3>Period Total Sales</h3>
          <div class="value" id="period-sales">GHS 0</div>
          <div class="label" id="period-label">Today</div>
        </div>
        <div class="stat-card glass">
          <h3>Total Shop Float</h3>
          <div class="value" id="total-float">GHS 0</div>
          <div class="label">All Agent Balances</div>
        </div>
        <div class="stat-card glass">
          <h3>Active Agents</h3>
          <div class="value" id="active-agents">0</div>
          <div class="label" id="active-label">In this period</div>
        </div>
      </div>

      <div class="section glass">
        <h2>Live Activity Feed</h2>
        <div class="activity-feed" id="activity-feed">
          <p class="text-center py-16 opacity-70">Loading real-time transactions...</p>
        </div>
      </div>

      <div class="section glass">
        <h2>Top Performing Agents</h2>
        <div id="agent-ranking" class="agent-ranking">
          <p class="text-center py-10 opacity-70">Loading rankings...</p>
        </div>
      </div>

      <div class="chart-container glass">
        <h2>Sales Trend</h2>
        <canvas id="salesChart"></canvas>
      </div>
    </main>

    <!-- NOTIFICATIONS + ONLINE USERS -->
    <aside class="notifications glass">
      <div class="notif-header">
        <h2>Online Users</h2>
        <span class="notif-close" onclick="this.parentElement.parentElement.style.display='none'">×</span>
      </div>
      <div id="online-users-list" class="max-h-96 overflow-y-auto">
        <p class="text-center opacity-70">Loading online users...</p>
      </div>

      <hr class="my-6 border-white/20">

      <div class="notif-header">
        <h2>Notifications</h2>
      </div>
      <div class="notif-filters">
        <button class="active">All</button>
        <button>Float</button>
        <button>Sales</button>
        <button>Agents</button>
      </div>
      <div id="notif-list">
        <p class="text-center opacity-70">No new notifications</p>
      </div>
    </aside>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) { alert("Please login first"); window.location.href = "../login.html"; }

    const user = JSON.parse(localStorage.getItem("user") || "{}");
    document.getElementById("admin-name").textContent = `${user.first_name || "Admin"} ${user.last_name || ""}`.trim();

    let currentPeriod = "day";
    let salesChart;
    let socketConnected = false;
    let isRealtimeUpdate = false;

    function logout() { 
      if(confirm("Logout?")) { 
        localStorage.clear(); 
        window.location.href="../login.html"; 
      } 
    }

    // Updated switchPeriod with "This Month" support
    function switchPeriod(period){
      currentPeriod = period;
      document.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
      document.querySelector(`[onclick="switchPeriod('${period}')"]`).classList.add("active");
      
      let label = "Today";
      if (period === "week") label = "This Week";
      if (period === "month") label = "This Month";
      
      document.getElementById("period-label").textContent = label;
      loadAllData();
    }

    async function loadAllData(){
      if(isRealtimeUpdate) return;
      await Promise.all([loadDashboardStats(), loadActivityFeed(), loadAgentRanking(), drawSalesChart()]);
    }

    // SAFE FETCH HELPER
    async function safeFetch(url) {
      try {
        const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (err) {
        console.warn(`Failed to load ${url}:`, err.message);
        return null;
      }
    }

    // DYNAMIC MENU
    async function loadDynamicMenu() {
      const data = await safeFetch('/api/admin/menu');
      const menu = document.getElementById('dynamic-menu');

      if (data && Array.isArray(data) && data.length > 0) {
        menu.innerHTML = '';
        data.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="${item.href}" ${item.active ? 'class="active"' : ''}>
            <i class="${item.icon}"></i> ${item.title}
          </a>`;
          menu.appendChild(li);
        });
      } else {
        menu.innerHTML = `
          <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li><a href="admin-agents.html"><i class="fas fa-users"></i> All Agents</a></li>
          <li><a href="admin-float.html"><i class="fas fa-wallet"></i> Float Control</a></li>
          <li><a href="admin-payroll.html"><i class="fas fa-money-bill-wave"></i> Pay Commission</a></li>
          <li><a href="admin-branch.html"><i class="fas fa-building"></i> Branches</a></li>
          <li><a href="admin-history.html"><i class="fas fa-history"></i> History</a></li>
          <li><a href="admin-reports.html"><i class="fas fa-chart-bar"></i> Reports</a></li>
        `;
      }
    }

    // ONLINE USERS
    async function loadOnlineUsers() {
      const list = document.getElementById('online-users-list');
      const data = await safeFetch('/api/admin/online-users');

      if (data && Array.isArray(data) && data.length > 0) {
        list.innerHTML = '';
        data.forEach(u => {
          const div = document.createElement('div');
          div.className = 'online-user';
          div.innerHTML = `
            <div class="online-dot"></div>
            <div>
              <strong>${u.name || u.username}</strong>
              <div class="text-sm opacity-70">${(u.device_info || 'Unknown device').substring(0,40)}...</div>
              <div class="text-xs opacity-50">${u.ip_address || 'Unknown IP'} • ${u.login_time || 'Recent'}</div>
            </div>
          `;
          list.appendChild(div);
        });
      } else {
        list.innerHTML = '<p class="text-center opacity-70">No one online right now</p>';
      }
    }

    // DASHBOARD STATS
    async function loadDashboardStats() {
      try {
        const res = await fetch(`/api/admin/dashboard?period=${currentPeriod}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const data = await res.json();
        document.getElementById("period-sales").textContent = `GHS ${Number(data.period_sales || 0).toLocaleString()}`;
        document.getElementById("total-float").textContent = `GHS ${Number(data.total_float || 0).toLocaleString()}`;
        document.getElementById("active-agents").textContent = data.active_agents || 0;
      } catch (err) {
        console.error('Stats load error:', err);
        document.getElementById("period-sales").textContent = 'GHS 0';
        document.getElementById("total-float").textContent = 'GHS 0';
        document.getElementById("active-agents").textContent = '0';
      }
    }

    // ACTIVITY FEED
    async function loadActivityFeed() {
      try {
        const res = await fetch(`/api/admin/dashboard?period=${currentPeriod}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const data = await res.json();
        const feed = document.getElementById("activity-feed");
        if (!data.recent_activity?.length) {
          feed.innerHTML = "<p>No activity</p>";
          return;
        }
        feed.innerHTML = data.recent_activity.map(a => `
          <div class="activity-item">
            <i class="fas fa-exchange-alt"></i>
            <div>
              <strong>${a.name}</strong> ${a.action}
              <div style="font-size:14px;opacity:0.7">${a.service}</div>
            </div>
            <div class="activity-amount">+GHS ${Number(a.amount).toLocaleString()}</div>
          </div>
        `).join("");
      } catch (err) {
        console.error('Activity load error:', err);
        document.getElementById("activity-feed").innerHTML = "<p>No activity</p>";
      }
    }

    // AGENT RANKING
    async function loadAgentRanking() {
      try {
        const res = await fetch(`/api/admin/agent-ranking?period=${currentPeriod}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const { data } = await res.json();
        const container = document.getElementById("agent-ranking");
        if (!data?.length) {
          container.innerHTML = "<p>No sales yet</p>";
          return;
        }
        container.innerHTML = data.map((a, i) => `
          <div class="agent-row">
            <div class="agent-rank">#${i+1}</div>
            <div class="agent-name">${a.name}</div>
            <div class="agent-sales">GHS ${Number(a.total_amount).toLocaleString()}</div>
          </div>
        `).join("");
      } catch (err) {
        console.error('Ranking load error:', err);
        document.getElementById("agent-ranking").innerHTML = "<p>No sales yet</p>";
      }
    }

    // SALES CHART
    async function drawSalesChart() {
      try {
        const days = currentPeriod === "day" ? 1 : currentPeriod === "week" ? 7 : 30;
        const res = await fetch(`/api/admin/analytics/sales?days=${days}`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const { data } = await res.json();
        const labels = data.map(d => d.day);
        const values = data.map(d => d.total);

        const ctx = document.getElementById("salesChart").getContext("2d");
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
          type: "line",
          data: { labels, datasets: [{ data: values, borderColor: "#ffb300", backgroundColor: "rgba(255,177,0,0.2)", tension: 0.4 }] },
          options: { responsive: true }
        });
      } catch (err) {
        console.error('Chart load error:', err);
        const ctx = document.getElementById("salesChart").getContext("2d");
        ctx.font = "16px Arial";
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.fillText("No data available", ctx.canvas.width / 2, ctx.canvas.height / 2);
      }
    }

    // SOCKET.IO
    const socket = io();
    socket.on("connect", () => {
      socketConnected = true;
      socket.emit("registerUser", user);
    });

    socket.on("newTransaction", (txn) => {
      isRealtimeUpdate = true;
      prependActivity(txn);
      loadDashboardStats();
      setTimeout(() => isRealtimeUpdate = false, 1500);
    });

    socket.on("activeAgentsUpdate", (count) => {
      document.getElementById("active-agents").textContent = count;
    });

    function prependActivity(txn) {
      const feed = document.getElementById("activity-feed");
      const item = document.createElement("div");
      item.className = "activity-item";
      item.innerHTML = `
        <i class="fas fa-exchange-alt"></i>
        <div>
          <strong>${txn.agent_name || "Agent"}</strong> ${txn.type}
          <div style="font-size:14px;opacity:0.7">Just now</div>
        </div>
        <div class="activity-amount">+GHS ${Number(txn.amount).toLocaleString()}</div>
      `;
      feed.prepend(item);
    }

    // INITIAL LOAD
    window.addEventListener('DOMContentLoaded', () => {
      loadDynamicMenu();
      loadAllData();
      loadOnlineUsers();
      setInterval(loadOnlineUsers, 30000);
    });
  </script>
</body>
</html>