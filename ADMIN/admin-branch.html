<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Branch Performance Analytics • My MoMo Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Segoe UI', sans-serif; }
    .glass { backdrop-filter: blur(16px) saturate(180%); background-color: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.2); }
    .sidebar { transition: transform 0.3s ease-in-out; }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
    }
    #toast { display: none; }
    #toast.show { display: block; animation: slideIn 0.5s, slideOut 0.5s 3.5s forwards; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }
  </style>
</head>
<body class="text-white min-h-screen">

  <!-- Mobile Menu Button -->
  <button id="menu-btn" class="md:hidden fixed top-6 left-6 z-50 bg-white/20 p-4 rounded-2xl backdrop-blur-lg shadow-xl">
    <i class="fas fa-bars text-2xl"></i>
  </button>

  <div class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed md:static inset-y-0 left-0 z-40 w-80 glass shadow-2xl flex flex-col">
      <div class="p-8 text-center border-b border-white/20">
        <div class="w-28 h-28 bg-white/20 rounded-full mx-auto mb-4 flex items-center justify-center text-5xl font-bold">A</div>
        <h2 class="text-3xl font-bold">Welcome Admin</h2>
        <p class="text-purple-200 mt-2">Queen of the Shop</p>
      </div>
      <nav class="flex-1 p-6">
        <ul class="space-y-4">
          <li><a href="admin.html" class="flex items-center gap-5 py-5 px-8 rounded-2xl hover:bg-white/10 transition"><i class="fas fa-tachometer-alt text-xl"></i><span class="text-xl font-medium">Overview</span></a></li>
          <li><a href="admin-agents.html" class="flex items-center gap-5 py-5 px-8 rounded-2xl hover:bg-white/10 transition"><i class="fas fa-users text-xl"></i><span class="text-xl font-medium">Manage Agents</span></a></li>
          <li><a href="admin-branches.html" class="flex items-center gap-5 py-5 px-8 rounded-2xl hover:bg-white/10 transition"><i class="fas fa-building text-xl"></i><span class="text-xl font-medium">Branches & Staff</span></a></li>
          <li><a href="admin-float.html" class="flex items-center gap-5 py-5 px-8 rounded-2xl hover:bg-white/10 transition"><i class="fas fa-wallet text-xl"></i><span class="text-xl font-medium">Float Control</span></a></li>
          <li><a href="admin-payroll.html" class="flex items-center gap-5 py-5 px-8 rounded-2xl hover:bg-white/10 transition"><i class="fas fa-money-bill-wave text-xl"></i><span class="text-xl font-medium">Pay Salaries</span></a></li>
          <li><a href="admin-reports.html" class="flex items-center gap-5 py-5 px-8 rounded-2xl bg-white/20 shadow-lg"><i class="fas fa-chart-bar text-xl"></i><span class="text-xl font-medium">Reports</span></a></li>
        </ul>
      </nav>
      <div class="p-6 border-t border-white/20 text-center"><p class="text-sm opacity-80">© 2025 My MoMo Empire</p></div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8 md:p-12">
      <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
          <h1 class="text-5xl font-bold">Branch Performance Analytics</h1>
          <select id="date-range" class="px-6 py-4 rounded-2xl bg-white/10 text-white">
            <option value="today">Today</option>
            <option value="week">Last 7 Days</option>
            <option value="month" selected>This Month</option>
            <option value="all">All Time</option>
          </select>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-12">
          <div class="glass p-6 rounded-3xl text-center"><h3 class="text-lg opacity-80">Total Branches</h3><p id="stat-branches" class="text-4xl font-bold mt-2">-</p></div>
          <div class="glass p-6 rounded-3xl text-center"><h3 class="text-lg opacity-80">Total Revenue</h3><p id="stat-revenue" class="text-4xl font-bold mt-2 text-green-400">-</p></div>
          <div class="glass p-6 rounded-3xl text-center"><h3 class="text-lg opacity-80">Total Transactions</h3><p id="stat-transactions" class="text-4xl font-bold mt-2 text-blue-400">-</p></div>
          <div class="glass p-6 rounded-3xl text-center"><h3 class="text-lg opacity-80">Avg Revenue/Branch</h3><p id="stat-avg" class="text-4xl font-bold mt-2 text-yellow-400">-</p></div>
          <div class="glass p-6 rounded-3xl text-center"><h3 class="text-lg opacity-80">Top Branch</h3><p id="stat-top" class="text-3xl font-bold mt-2 text-purple-300">-</p></div>
        </div>

        <!-- Revenue Bar Chart -->
        <div class="glass rounded-3xl p-8 mb-12 shadow-2xl">
          <h2 class="text-3xl font-bold mb-6 text-center">Revenue by Branch (GHS)</h2>
          <canvas id="revenueChart" height="100"></canvas>
        </div>

        <!-- Branches Performance Table -->
        <div class="glass rounded-3xl overflow-hidden shadow-2xl">
          <div class="p-8 border-b border-white/10">
            <h2 class="text-3xl font-bold">Detailed Branch Performance</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-white/10">
                <tr>
                  <th class="p-6 text-left text-xl font-bold">Branch Name</th>
                  <th class="p-6 text-left text-xl font-bold">Location</th>
                  <th class="p-6 text-left text-xl font-bold">Manager</th>
                  <th class="p-6 text-left text-xl font-bold">Agents</th>
                  <th class="p-6 text-left text-xl font-bold">Revenue (GHS)</th>
                  <th class="p-6 text-left text-xl font-bold">Transactions</th>
                </tr>
              </thead>
              <tbody id="performanceTable">
                <tr><td colspan="6" class="p-12 text-center opacity-60">Loading analytics...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-8 right-8 z-50">
    <div class="bg-white text-gray-800 px-8 py-5 rounded-2xl shadow-2xl flex items-center gap-4">
      <i id="toast-icon" class="fas fa-check-circle text-3xl text-green-500"></i>
      <span id="toast-message" class="font-bold text-xl"></span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_BASE = '/api/branches';
    const token = localStorage.getItem('token');

    if (!token) {
      alert('Please login first');
      window.location.href = '/login.html';
    }

    let revenueChart;

    function showToast(message, success = true) {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const msg = document.getElementById('toast-message');
      msg.textContent = message;
      icon.className = success ? "fas fa-check-circle text-3xl text-green-500" : "fas fa-exclamation-circle text-3xl text-red-500";
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 4000);
    }

    async function loadAnalytics() {
      try {
        const res = await fetch(API_BASE + '/analytics', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Failed');

        // Stats cards
        document.getElementById('stat-branches').textContent = data.totalBranches;
        document.getElementById('stat-revenue').textContent = 'GHS ' + Number(data.totalRevenue).toLocaleString();
        document.getElementById('stat-transactions').textContent = data.totalTransactions.toLocaleString();
        document.getElementById('stat-avg').textContent = 'GHS ' + Number(data.avgRevenue).toLocaleString();
        document.getElementById('stat-top').textContent = data.topBranch.name;

        // Bar chart
        const ctx = document.getElementById('revenueChart').getContext('2d');
        if (revenueChart) revenueChart.destroy();
        revenueChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.performance.map(p => p.name),
            datasets: [{
              label: 'Revenue (GHS)',
              data: data.performance.map(p => p.revenue),
              backgroundColor: 'rgba(139, 92, 246, 0.6)',
              borderColor: '#8b5cf6',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });

        // Performance table
        const tbody = document.querySelector('#performanceTable');
        tbody.innerHTML = '';
        data.performance.forEach(b => {
          tbody.innerHTML += `
            <tr class="hover:bg-white/10">
              <td class="p-6 font-bold text-xl">${b.name}</td>
              <td class="p-6">${b.location || '-'}</td>
              <td class="p-6">${b.manager_fullname || b.manager_name || '<i class="opacity-60">None</i>'}</td>
              <td class="p-6 text-center font-bold text-2xl text-purple-300">${b.agent_count}</td>
              <td class="p-6 text-green-400 font-bold text-xl">GHS ${Number(b.revenue).toLocaleString()}</td>
              <td class="p-6 text-blue-400 font-bold text-xl">${b.transactions.toLocaleString()}</td>
            </tr>`;
        });
      } catch (err) {
        showToast('Failed to load analytics', false);
        console.error(err);
      }
    }

    // Date range change
    document.getElementById('date-range').addEventListener('change', loadAnalytics);

    // Mobile menu
    document.getElementById('menu-btn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
    });

    // Load on start
    loadAnalytics();
  </script>
</body>
</html>